<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>AWS Analysis</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script> -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.bundle.min.js" integrity="sha384-3ziFidFTgxJXHMDttyPJKDuTlmxJlwbSkojudK/CkRqKDOmeSbN6KLrGdrBQnT2n" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.6/popper.min.js"></script>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
  <link href="index.css" rel="stylesheet">
</head>

<body>
  <nav class="navbar navbar-toggleable-md navbar-light bg-faded">
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="index.html">Home</a>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="index.html">Home <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="tableau.html">Tableau</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/aws-analysis/aws-analysis.github.io">View Code on Github</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="contact.html">Contact</a>
        </li>
      </ul>
    </div>
  </nav>
  <div class="content">
    <div class="row">
      <div class="col-lg-12">
        <div class="text-center heading">
          <h1>Welcome to AWS Tweet Enhancer!</h1>
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:4em">
      <div class="col-lg-2 side-left">

      </div>
      <div class="col-lg-4">
        <form id="form" class="">
          Tweet Text:<br>
          <textarea maxlength="240" form="form" required name="tweet-text"></textarea><br>
          Klout Score of Tweeter:<br>
          <input required type="text" name="klout"><br>
          Tweet Day:<br>
          <input required list="days" name="day"><br>
            <datalist id="days">
              <option value="Monday">
              <option value="Tuesday">
              <option value="Wednesday">
              <option value="Thursday">
              <option value="Friday">
              <option value="Saturday">
              <option value="Sunday">
            </datalist>
          Tweet Time:<br>
          <input required id="tweet-time" name="time" class="time ui-timepicker-input" autocomplete="off" type="text"><br><br>
          Country:<br>
          <input required type="textarea" name="country"><br>
          State:<br>
          <input required type="textarea" name="state"><br>
          City:<br>
          <input required type="textarea" name="city"><br>
          Gender:<br>
          <input type="radio" name="gender" value="Male"> Male<br>
          <input type="radio" name="gender" value="Female"> Female<br>
          <input type="radio" name="gender" value="Unisex"> Unisex<br>
          <input type="radio" name="gender" value="Unknown"> Unknown<br>
          <input type="submit" class="btn btn-primary" value="submit">
        </form>
      </div>
      <div class="col-lg-4">
        <!-- Predicted Retweets: <span id="result-num"></span> -->
        <h2 class="results" id="thisTweet"></h2>
        <span class="results" style="font-size:24px; font-weight:bolder;"id="results"></span>
        <div id="loader2"></div>
        <div id="instructions">
          <p class="lead">
            Fill the form on the left and submit to see the expected number of ReTweets for your tweet and details provided. We will also provide some suggestions on other times that might be better for your tweet to be sent.
          </p>
          <p>
          This tool is in an evaluation stage and in order to use the Machine Learning API, your browser must have security disabled. As the tool is further evaluated we will do what is necessary to have our API CORS friendly so that we can allow others to consume our API as well. To disable security features in Chrome please see <a href="https://stackoverflow.com/questions/36016952/chrome-49-plus-disable-web-security">this answer on Stack Overflow</a> (use CTRL+F to find your operating system).
          </p>
        </div>
      </div>
      <div class="col-lg-2 side-right">

      </div>
    </div>
  </div>
  <div class="loader"></div>
</body>
<link href="jquery.timepicker.min.css" rel="stylesheet">
<script src="jquery.timepicker.js" type="text/javascript"></script>
<script>
  var counter = 0;
  $('#form').on('submit', function(e) {
    e.preventDefault();
    $('#results').html("")
    counter = 0;
    $('#instructions').hide();
    $('.results').hide();
    $('#loader2').show();
    var key = "nvJ8v12HjRZpodiTbJk+lGuBJfALvLfbo0Tp/bpBRBR2Rodbd/5DBNOcqA6O/zjQIKpBN0SjJhSDRo/9TaPxFA==";
    var HourMs = "";
    var DayMs = "";
    var IsReshare = "false";
    var RetweetCount = "0";
    var Klout = "";
    var Country = "";
    var State = "";
    var City = "";
    var Gender = "Unknown";
    var text = "";
    var URL = "false";
    var values = $(this).serializeArray();
    for (var index = 0; index < values.length; index++){
      switch(values[index].name){
        case "tweet-text":
          text = values[index].value;
          if(text.toString().includes('.com') || text.toString().includes('.org') || text.toString().includes('www.') || text.toString().includes('http'))
            URL = "true";
          break;
        case "time":
          time = values[index].value;
          hours = time.toString().split(":")[0];
          pm = time.toString().includes("pm");
          if(pm)
            hours = parseInt(hours) + 12;
          HourMs = hours.toString();
          break;
        case "klout":
          Klout = values[index].value;
          break;
        case "country":
          Country = values[index].value;
          break;
        case "day":
          DayMs = values[index].value;
          break;
        case "gender":
          Gender = values[index].value;
          break;
        case "state":
          State = values[index].value;
          break;
        case "city":
          City = values[index].value;
          break;
      }
    }
    var input1 = [{
      'HourMs' : HourMs,
      'DayMs' : DayMs,
      'IsReshare' : IsReshare,
      'RetweetCount' : RetweetCount,
      'Klout' : Klout,
      'Country' : Country,
      'State' : State,
      'City' : City,
      'Gender' : Gender,
      'text' : text,
      'URL' : URL
    }]

    var data = {
      "Inputs": {
        "input1":
        [
          {
            'HourMs' : HourMs,
            'DayMs' : DayMs,
            'IsReshare' : IsReshare,
            'RetweetCount' : RetweetCount,
            'Klout' : Klout,
            'Country' : Country,
            'State' : State,
            'City' : City,
            'Gender' : Gender,
            'text' : text,
            'URL' : URL
          }
        ],
      },
      "GlobalParameters": {}
    }

    var body = JSON.stringify(data);
    SendData(body, "Predicted Retweets: ");

    var times = ['3', '5', '8', '11'];

    for (var index = 0; index < times.length; index++){
      if(times[index] == HourMs)
        continue;
      var data = {
        "Inputs": {
          "input1":
          [
            {
              'HourMs' : times[index],
              'DayMs' : DayMs,
              'IsReshare' : IsReshare,
              'RetweetCount' : RetweetCount,
              'Klout' : Klout,
              'Country' : Country,
              'State' : State,
              'City' : City,
              'Gender' : Gender,
              'text' : text,
              'URL' : URL
            }
          ],
        },
        "GlobalParameters": {}
      }

      var body = JSON.stringify(data);
      SendData(body);
    }

    });

    function SendData(body, name) {
      $.ajax({
            type: "POST",
            url: "https://ussouthcentral.services.azureml.net/workspaces/4d52a741d22d4e09b6564d071f335541/services/545434c7687944a29f3d165ddcd11e81/execute?api-version=2.0&format=swagger",
            data: body,
            error: function(data, errorThrown)
              {
                  $('#loader2').hide();
                  $('#instructions').html("An error occurred, check your tweet and try again.").show();
              },
            headers: {
                "Authorization": "Bearer nvJ8v12HjRZpodiTbJk+lGuBJfALvLfbo0Tp/bpBRBR2Rodbd/5DBNOcqA6O/zjQIKpBN0SjJhSDRo/9TaPxFA==",
                "Content-Type": "application/json;charset=utf-8"
            }
        }).done(function (data) {
            if(name){
              UpdateThisTweet(data);
              return true;
            } else {
              body = JSON.parse(body);
              var hour = body['Inputs']['input1'][0]['HourMs'];
              UpdateResultLabels(hour + " am: ", hour)
              UpdateResults(data, hour);
          }
        });
    }


    function UpdateThisTweet(data){
      var result = data['Results']["output1"][0]['Scored Labels'].toString().split(".")[0];
      if(parseInt(result) < 0)
        result = 0;
      $('.results').show();
      $("#thisTweet").html("Predicted ReTweets: " + result);
    }

    function UpdateResultLabels(label, id){
      var resultText = $('#results').html()
      var newResult = resultText + '<br><p>' + label + '<span id="label' + id + '"></span></span></p>';
      $('#results').html(newResult);
    }

    function UpdateResults(data, label) {
      var result = data['Results']["output1"][0]['Scored Labels'].toString().split(".")[0];
      if(parseInt(result) < 0)
        result = 0;
      $('.results').show();
      $("#label" + label).html(result);
      $('#loader2').hide();
    }
    $('#loader2').hide();
  $('.results').hide();
  $('#tweet-time').timepicker({ 'scrollDefault': 'now' });
  $(window).on('load', function(){
     $('.loader').fadeOut();
   });

</script>
</html>
